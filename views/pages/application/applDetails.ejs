<style>
    .btn-outline-light.custom-btn {
        background-color: #ee9153;
        border-color: #ee9153;
    }
</style>
<script src="https://kit.fontawesome.com/a24879a822.js" crossorigin="anonymous"></script>
<section class="h-100 h-custom" style="background-color: #eee;">
    <div class="container py-5 h-100">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-8">
                <div class="card border-top border-bottom border-3" style="border-color: #f37a27 !important;">
                    <div class="card-body p-5">
                        <a href="#" onclick="history.back()"><i class="fas fa-xmark"
                                style="color: #f37a27; float: right; font-size: 25px;"></i></a>
                        <p class="lead fw-bold mb-5" style="color: #f37a27;">Application Details</p>

                        <div class="row">
                            <div class="col mb-3">
                                <% if(appl.relatedExp){ %>
                                    <p class="small text-muted mb-1">Care Seeker: </p>
                                    <p>
                                        <%= appl.reg_target_name %>
                                    </p>
                            </div>

                            <div class="col mb-3">
                                <p class="small text-muted mb-1">Care Provider: </p>
                                <p>
                                    <%= appl.reg_user_name %>
                                </p>
                                <% } else { %>
                                    <p class="small text-muted mb-1">Care Seeker: </p>
                                    <p>
                                        <%= appl.reg_user_name %>
                                    </p>
                            </div>

                            <div class="col mb-3">
                                <p class="small text-muted mb-1">Care Provider: </p>
                                <p>
                                    <%= appl.reg_target_name %>
                                </p>
                                <% } %>
                            </div>
                        </div>

                        <div class="mx-n5 px-5 py-4" style="background-color: #f2f2f2;" id="interviewTimeslotTitle">
                            <p class=" lead fw-bold mb-4 pb-2" style="color: #f37a27;">Interview Timeslot</p>
                            <p id="rejectText" style="color: #f37a27; display: none;">This application had been
                                rejected.
                            </p>
                            <% if(typeof appl.interviewTimeslot !="object" ) { %>
                                <div class="row my-4">
                                    <div class="col-md-8 col-lg-9">
                                        <p>
                                            <%= appl.interviewTimeslot %>
                                        </p>
                                    </div>
                                    <div class="col-md-4 col-lg-3">
                                        <button type="button" class="accept-btn btn btn-outline-light custom-btn"
                                            id="accept"
                                            onclick="actions('<%= appl.id %>', 'approved', '<%= appl.interviewTimeslot %>')">Accept</button>
                                    </div>

                                </div>
                                <% if(appl.applStatus=="approved" ){ %>
                                    <div class="row my-4">
                                        <div class="col-md-8 col-lg-9">
                                            <p id="acceptText" style="color: #f37a27;">This Application
                                                is
                                                waiting for interview
                                            </p>
                                        </div>
                                    </div>
                                    <% }; %>

                                        <% } else { %>
                                            <% for (let i=0; i < appl.interviewTimeslot.length; i++) { %>
                                                <div class="row my-4">
                                                    <div class="col-md-8 col-lg-9">
                                                        <p>
                                                            <%= appl.interviewTimeslot[i] %>
                                                        </p>
                                                    </div>
                                                    <div class="col-md-4 col-lg-3">
                                                        <button type="button"
                                                            class="accept-btn btn btn-outline-light custom-btn"
                                                            id="accept"
                                                            onclick="actions('<%= appl.id %>', 'approved', '<%= appl.interviewTimeslot[i] %>')">Accept</button>
                                                    </div>
                                                </div>
                                                <% }; %>
                                                    <% }; %>
                        </div>
                        <br>
                        <% if(appl.relatedExp){ %>
                            <p id="aiTitle" class="lead fw-bold mb-4 pb-2" style="color: #f37a27;">Related Experiences
                            </p>
                            <p id="expText" style="">
                                - <%= appl.relatedExp %>
                            </p>
                            <% }; %>

                                <p id="actionTitle" class="lead fw-bold pb-2" style="color: #f37a27;">Actions</p>

                                <div>
                                    <div class="row my-4">
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-light custom-btn"
                                                id="rearrange" onclick="openForm()">Rearrange</button>
                                        </div>



                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-light custom-btn" id="reject"
                                                onclick="actions('<%= appl.id %>', 'rejected', ' ')">Reject</button>
                                        </div>
                                    </div>

                                    <% if(appl.applStatus=="approved" && req.session.userId !=appl.reg_user ){ %>
                                        <div class="row my-4">
                                            <div class="col-md-3">
                                                <a href="/images/Employment_contract.doc" download="Employment_Contract"
                                                    type="button" class="btn btn-outline-light custom-btn" id="download"
                                                    data-toggle="tooltip" data-placement="top"
                                                    title="Download a contract template to fill">Download
                                                    Contract</a>
                                            </div>

                                            <div class="col-md-3" style="padding: 0 2rem;">
                                                <button type="button" class="btn btn-outline-light custom-btn"
                                                    id="acceptAppl"
                                                    onclick="actions('<%= appl.id %>', 'accept application', ' ')"
                                                    data-toggle="tooltip" data-placement="top"
                                                    title="Confirm this Application">Accept
                                                    Application</button>
                                            </div>

                                            <div class="col-md-3" style="padding: 0 3rem;">
                                                <button type="button" class="btn btn-outline-light custom-btn"
                                                    id="rejectAppl"
                                                    onclick="actions('<%= appl.id %>', 'reject application', ' ')"
                                                    data-toggle="tooltip" data-placement="top"
                                                    title="Once reject, the whole application will be withdraw">Reject
                                                    Application</button>
                                            </div>
                                        </div>
                                        <% }; %>
                                            <% if(appl.applStatus=="accept application" ){ %>
                                                <div class="row my-4">
                                                    <div class="col-md-3">
                                                        <button type="button" class="btn btn-outline-light custom-btn"
                                                            id="chat" data-toggle="tooltip" data-placement="top"
                                                            title="Leave message regarding the appointment">Chat with
                                                            him/her</button>
                                                    </div>

                                                    <div class="col-md-3" style="padding: 0 1em;">
                                                        <button type="button" class="btn btn-outline-light custom-btn"
                                                            id="finished" data-toggle="tooltip" data-placement="top"
                                                            title="Click to end the contract"
                                                            onclick="actions('<%= appl.id %>', 'finished', ' ')">Appointment
                                                            Finish</button>
                                                    </div>
                                                </div>

                                                <% }; %>
                                                    <% if(appl.applStatus=="reject application" && req.session.userId
                                                        !=appl.reg_user ){ %>
                                                        <div class="row my-4">
                                                            <div class="col-md-12">
                                                                <p id="rejectApplTitle" style="color: #f37a27;">
                                                                    Do you want to leave a message or feedback to the
                                                                    Candidate?
                                                                </p>
                                                                <button type="button"
                                                                    class="btn btn-outline-light custom-btn"
                                                                    id="leaveMsg"
                                                                    onclick="document.getElementById('msgForm').style.display = '';">Leave
                                                                    Message</button>
                                                            </div>

                                                        </div>
                                                        <% }; %>

                                </div>

                                <div id="applStatus">
                                    <p class="lead fw-bold mb-4 pb-2" style="color: #f37a27;">Application Status</p>
                                    <h3><span class="badge badge-pill badge-primary" style="background-color: #ee9153;">
                                            <%= appl.applStatus %>
                                        </span></h3>
                                    <% if(appl.reject_msg){ %>
                                        <p id="rejectMsg" style="color: #f37a27;">
                                            This application is rejected because:
                                            <%= appl.reject_msg %>
                                        </p>
                                        <% }; %>
                                </div>

                                <form id="formData"
                                    style="display: none; position: inline-block;border: 1px solid #f37a27; background-color: white;"
                                    class="form-container" onsubmit="return false">
                                    <input type="hidden" name="_csrf" id="_csrf" value="<%- _csrf %>" />
                                    <div class="form-group">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered table-hover add_row"
                                                id="details">
                                                <thead>
                                                    <tr>
                                                        <th>Date <button type="button" id="add_details_button"
                                                                class="btn btn-outline-light custom-btn add_details_button "
                                                                style="float: right;"><i class="fa fa-plus"></i>
                                                            </button></th>
                                                        <th>Delete</th>
                                                    </tr>
                                                </thead>
                                                <tr>
                                                    <td>
                                                        <input id="date0" name="interviewTimeslot" class="form-control"
                                                            type="datetime-local" />
                                                    </td>
                                                    <td>
                                                        <button type="button"
                                                            class="delete btn btn-dark">Delete</button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <button type="submit" class="col btn btn-success" style="margin-bottom: 0.5em;"
                                        onclick="rearrange('<%= appl.id %>', 'rearranging')">Send</button>
                                    <button type="button" class="col btn cancel btn-danger"
                                        onclick="closeForm()">Close</button>
                                </form>

                                <form id="msgForm" style=" display: none; position: inline-block;border: 1px solid #f37a27;
                                    background-color: white;" class="form-container" onsubmit="return false">
                                    <input type="hidden" name="_csrf" id="_csrf" value="<%- _csrf %>" />
                                    <div class="form-group">
                                        <label for="msg">Please leave your message here:</label>
                                        <textarea class="form-control" id="msg" name="reject_msg" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="col btn btn-outline-light custom-btn"
                                        style="margin-bottom: 0.5em;" onclick="sendMsg('<%= appl.id %>')">Send</button>
                                </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script>
    loadPage()
    window.onload = function () {
        $('[data-toggle="tooltip"]').tooltip()
    }

    function loadPage() {
        if ("<%- appl.applStatus %>" == "approved") {
            document.getElementById("accept").style.display = "none";
            document.getElementById("reject").style.display = "none";
            document.getElementById("rearrange").style.display = "none";

        } else if ("<%- appl.applStatus %>" == "rejected") {
            document.getElementById("rejectText").style.display = '';
            document.getElementById("accept").style.display = "none";
            document.getElementById("reject").style.display = "none";
            document.getElementById("rearrange").style.display = "none";
        } else if ("<%- appl.applStatus %>" == "rearranging" && "<%- appl.reg_user %>" != "<%- req.session.userId %>") {
            document.getElementById("actionTitle").style.display = "none";
            document.querySelectorAll('.accept-btn').forEach(function (el) {
                el.disabled = true;
                el.innerText = "Waiting for reply...";
            });
            document.getElementById("reject").style.display = "none";
            document.getElementById("rearrange").style.display = "none";
        } else if ("<%- appl.applStatus %>" == "reject application") {
            document.getElementById("rejectText").style.display = '';
            document.getElementById("reject").style.display = "none";
            document.getElementById("rearrange").style.display = "none";
            document.querySelectorAll('.accept-btn').forEach(function (el) {
                el.style.display = 'none';
            });

        } else if ("<%- appl.applStatus %>" == "accept application") {
            document.getElementById("interviewTimeslotTitle").style.display = "none";
            document.getElementById("reject").style.display = "none";
            document.getElementById("rearrange").style.display = "none";
            document.querySelectorAll('.accept-btn').forEach(function (el) {
                el.style.display = 'none';
            });

        }

        if ("<%- appl.reg_user %>" == "<%- req.session.userId %>") {
            if ("<%- appl.applStatus %>" == "rearranging") {
                document.getElementById("reject").style.display = "none";
            } else {
                document.getElementById("applStatus").style.display = "";
                document.querySelectorAll('.accept-btn').forEach(function (el) {
                    el.style.display = 'none';
                });
                document.getElementById("actionTitle").style.display = "none";
                document.getElementById("reject").style.display = "none";
                document.getElementById("rearrange").style.display = "none";
            }

        }
    }

    async function actions(applId, action, interviewTimeslot) {
        var r = confirm("Confirm?");

        if (r) {
            var row = '<input type="hidden" name="action" value="' + action + '" /> ';
            $("#formData").append(row);
            var row2 = '<input type="hidden" name="interviewTimeslot" value="' + interviewTimeslot + '" /> ';
            $("#formData").append(row2);
            var form = document.getElementById("formData");
            var formData = new FormData(form);
            var response = await fetch("/application/applDetails?id=" + applId, {
                method: "PUT",
                body: formData,
            });
            console.log(formData);
            if (response.ok) {
                alert("Application updated!");
                location.reload(true);
            }
        } else {
            alert("cancelled");
        }
    }

    async function rearrange(applId, action) {
        var r = confirm("Confirm to rearrange the interview?");
        if (r) {
            var row = '<input type="hidden" name="action" value="' + action + '" /> ';
            $("#formData").append(row);
            var form = document.getElementById("formData");
            var formData = new FormData(form);
            var response = await fetch("/application/applDetails?id=" + applId, {
                method: "PUT",
                body: formData,
            });
            console.log(formData);
            if (response.ok) {
                alert("Application updated!");
                location.reload(true);
            }
        } else {
            alert("cancelled");
        }
    }

    async function sendMsg(applId) {
        var form = document.getElementById("msgForm");
        var formData = new FormData(form);
        var response = await fetch("/application/applDetails?id=" + applId, {
            method: "POST",
            body: formData,
        });
        console.log(formData);
        if (response.ok) {
            alert("Message sent!");
            location.reload(true);
        }

    }


    function openForm() {
        document.getElementById("formData").style.display = "";
        $(document).ready(function () {
            var count = 1;
            // Append table with add row form on add new button click
            $(".add_details_button").click(function () {    //button click to add row
                var row = '<tr>' +
                    '<td><input id="date' + count + '" name="interviewTimeslot"  class="form-control" type="datetime-local" required/></td>' + '<td><button type="button" class="delete btn btn-dark">Delete</button></td>' + '</tr>';
                count = count + 1;
                $("#details").append(row);
            });
            // Delete row on delete button click
            $(document).on("click", ".delete", function () {
                $(this).parents("tr").remove();
            });
        });
    }

    function closeForm() {
        document.getElementById("formData").style.display = "none";
    }
</script>